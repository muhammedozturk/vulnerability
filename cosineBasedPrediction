library("glmnet")
yazi <- read.table("D:/makaleler/vulnerability/results/apachelucene.txt",fill=TRUE)
emb1 <- makeX(yazi)
boyut <- dim(emb1)
#############percentage split rates configuration
tr <- round((boyut[1]*70)/100)
trX <- tr+1
test <- boyut[1]-tr
tr <- c(1:tr)
test <- c(trX:test)
###################
embeddingNames <- rownames(emb1)
embeddingNames[1] <- "select"
embeddingNames[2] <- "from"
embeddingNames[3] <- "command"
embeddingNames[4] <- "hash"
embeddingNames[5] <- "digest"
embeddingNames[6] <- "update"
resultLabeling <- doLabel(embeddingNames)
labels <- resultLabeling
#############################

###bu satır tanımlanırsa jtree için 0.82 ye düşülür accuracy
labels[1:1000] <- 0
###########labeling II############
yazi <- read.table("D:/makaleler/vulnerability/results/keywords.txt",fill=TRUE)
emb2 <- makeX(yazi)
emb2 <- emb2[-6,]
boyut <- dim(emb2) 
###exclude </s> from rows


############cosine similarity
require(rlist)
library(coop)
cosineVector <- c()

y=coop::cosine(emb1[1, ], emb1[17, ])
i <- 1
j <-1
araToplam <- 0
genelToplam <- 0
while(j<=boyut[2])
{

	while(i<=boyut[1])
	{
		araToplam <- araToplam +emb2[i,j]
		i <- i+1
	}
	genelAverage <- (araToplam/boyut[1])
	cosineVector <- append(cosineVector,genelAverage)
	araToplam <- 0
	j <- j+1
	i <- 1
}
cosineVector <- cosineVector[-16]
########################################
############labeling############################
i <- 1
j <- 1
vector <- c()
labels <- c()
labels <- rbinom( length(emb1[,1]), 1, 0.5)
boyut <- dim(emb1)
i <- 1
while(i<=boyut[1])
{
	y=coop::cosine(emb1[i, ], cosineVector)
	print(y)
	if(y>=0.5)
	labels[i] <- 1
	else
	labels[i] <- 0
	i <- i+1
}
###bu satır tanımlanırsa jtree için 0.82 ye düşülür accuracy
labels[1:1000] <- 0
library(text2vec)
library(data.table)
library(magrittr)




#########training phase
library(glmnet)
NFOLDS = 4
t1 = Sys.time()
glmnet_classifier = cv.glmnet(x = emb1[tr,], y = labels[tr], 
                              family = 'binomial', 
                              # L1 penalty
                              alpha = 1,
                              # interested in the area under ROC curve
                              type.measure = "deviance",
                              # 5-fold cross-validation
                              nfolds = NFOLDS,
                              # high value is less accurate, but has faster training
                              thresh = 1e-9,
                              # again lower number of iterations for faster training
                              maxit = 1e3)
print(difftime(Sys.time(), t1, units = 'sec'))
plot(glmnet_classifier)


preds = predict(glmnet_classifier, emb1[test,], type = 'response')[,1]
glmnet:::auc(labels[test], preds)
###################################
########label function##########################
